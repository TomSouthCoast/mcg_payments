<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCG Payment App</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2563eb">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="install-prompt" style="display: none; position: fixed; bottom: 1rem; left: 1rem; right: 1rem; background-color: white; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); align-items: center; justify-content: space-between; z-index: 1000;">
        <p style="margin: 0; font-family: sans-serif; color: #333;">Install the MCG Payment App for a better experience!</p>
        <div>
            <button id="install-button" style="background-color: #2563eb; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.25rem; cursor: pointer; margin-right: 0.5rem;">Install</button>
            <button id="install-dismiss" style="background-color: #e5e7eb; color: #333; border: none; padding: 0.5rem 1rem; border-radius: 0.25rem; cursor: pointer;">Dismiss</button>
        </div>
    </div>

    <div id="root"></div>
    
    <script>
      // PWA Install Prompt Logic
      let deferredPrompt;
      const installPrompt = document.getElementById('install-prompt');
      const installButton = document.getElementById('install-button');
      const dismissButton = document.getElementById('install-dismiss');

      window.addEventListener('beforeinstallprompt', (e) => {
        console.log('beforeinstallprompt event fired');
        e.preventDefault();
        deferredPrompt = e;
        if (installPrompt) {
          installPrompt.style.display = 'flex';
        }
      });

      if (installButton) {
        installButton.addEventListener('click', async () => {
          console.log('Install button clicked');
          if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`User response: ${outcome}`);
            deferredPrompt = null;
            if (installPrompt) {
              installPrompt.style.display = 'none';
            }
          }
        });
      }

      if (dismissButton) {
        dismissButton.addEventListener('click', () => {
          console.log('Dismiss button clicked');
          if (installPrompt) {
            installPrompt.style.display = 'none';
          }
          deferredPrompt = null;
        });
      }

      window.addEventListener('appinstalled', (evt) => {
        console.log('App was installed');
        if (installPrompt) {
          installPrompt.style.display = 'none';
        }
      });

      // Test manifest
      fetch('/manifest.json')
        .then(response => {
          console.log('Manifest status:', response.status);
          return response.json();
        })
        .then(data => console.log('Manifest data:', data))
        .catch(err => console.error('Manifest error:', err));
    </script>
    
    <script type="text/babel">
      const { useState, useEffect } = React;

      const MCGPaymentApp = () => {
        const [currentStep, setCurrentStep] = useState('main');
        const [paymentType, setPaymentType] = useState('');
        const [transactions, setTransactions] = useState([]);
        const [showAdmin, setShowAdmin] = useState(false);
        const [isAdminAuthenticated, setIsAdminAuthenticated] = useState(false);
        const [passwordInput, setPasswordInput] = useState('');
        const [passwordError, setPasswordError] = useState('');

        const ADMIN_PASSWORD = 'MCG2025';

        const handleAdminAccess = () => {
          setShowAdmin(true);
          setPasswordInput('');
          setPasswordError('');
        };

        const handlePasswordSubmit = (e) => {
          e.preventDefault();
          if (passwordInput === ADMIN_PASSWORD) {
            setIsAdminAuthenticated(true);
            setPasswordError('');
            setPasswordInput('');
          } else {
            setPasswordError('Incorrect password. Please try again.');
            setPasswordInput('');
          }
        };

        const handleAdminLogout = () => {
          setIsAdminAuthenticated(false);
          setShowAdmin(false);
          setPasswordInput('');
          setPasswordError('');
        };

        // Load transactions
        useEffect(() => {
          try {
            const saved = localStorage.getItem('mcg_transactions');
            if (saved) {
              setTransactions(JSON.parse(saved));
            }
          } catch (error) {
            console.error('Error loading transactions:', error);
          }
        }, []);

        const MainScreen = () => (
          <div className="space-y-6">
            <div className="text-center">
              <div className="bg-blue-600 text-white p-4 rounded-lg mb-6 relative">
                <button
                  onClick={handleAdminAccess}
                  className="absolute top-4 right-4 p-2 text-blue-100 hover:text-white hover:bg-blue-700 rounded"
                  title="Admin Panel"
                >
                  âš™ï¸
                </button>
                <h1 className="text-2xl font-bold">Mendip Caving Group</h1>
                <p className="text-blue-100">Payment System</p>
              </div>
              <p className="text-gray-600 mb-6">What would you like to pay for today?</p>
            </div>

            <div className="grid grid-cols-1 gap-4">
              <button
                onClick={() => {
                  setPaymentType('bed-nights');
                  setCurrentStep('details');
                }}
                className="p-6 bg-white border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors"
              >
                <div className="flex items-center justify-center space-x-3">
                  <span style={{fontSize: '24px'}}>ğŸŒ™</span>
                  <span className="text-lg font-semibold">Bed Nights</span>
                </div>
                <p className="text-gray-600 mt-2">Â£5/night (members) â€¢ Â£7.50/night (guests)</p>
              </button>

              <button
                onClick={() => {
                  setPaymentType('membership');
                  setCurrentStep('details');
                }}
                className="p-6 bg-white border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors"
              >
                <div className="flex items-center justify-center space-x-3">
                  <span style={{fontSize: '24px'}}>ğŸ‘¥</span>
                  <span className="text-lg font-semibold">MCG Membership</span>
                </div>
                <p className="text-gray-600 mt-2">Variable pricing based on membership type and join date</p>
              </button>

              <button
                onClick={() => {
                  setPaymentType('day-fees');
                  setCurrentStep('details');
                }}
                className="p-6 bg-white border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors"
              >
                <div className="flex items-center justify-center space-x-3">
                  <span style={{fontSize: '24px'}}>ğŸ“…</span>
                  <span className="text-lg font-semibold">Day Fees</span>
                </div>
                <p className="text-gray-600 mt-2">Â£2 per person per day (showers & kitchen use)</p>
              </button>

              <button
                onClick={() => {
                  setPaymentType('donation');
                  setCurrentStep('details');
                }}
                className="p-6 bg-white border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors"
              >
                <div className="flex items-center justify-center space-x-3">
                  <span style={{fontSize: '24px'}}>â¤ï¸</span>
                  <span className="text-lg font-semibold">Donations</span>
                </div>
                <p className="text-gray-600 mt-2">Support the Mendip Caving Group</p>
              </button>
            </div>
          </div>
        );

        const PasswordScreen = () => (
          <div className="space-y-6">
            <div className="flex items-center space-x-3 mb-6">
              <button onClick={() => setShowAdmin(false)} className="text-blue-600 hover:text-blue-800">
                <span style={{fontSize: '24px'}}>â†</span>
              </button>
              <h2 className="text-xl font-bold">Admin Access</h2>
            </div>

            <div className="bg-white p-6 rounded-lg border">
              <div className="text-center mb-6">
                <span style={{fontSize: '48px'}} className="block mb-3">ğŸ”’</span>
                <h3 className="text-lg font-semibold text-gray-800">Password Required</h3>
                <p className="text-gray-600">Enter admin password to access transaction management</p>
              </div>

              <form onSubmit={handlePasswordSubmit} className="space-y-4">
                <div>
                  <input
                    type="password"
                    value={passwordInput}
                    onChange={(e) => setPasswordInput(e.target.value)}
                    placeholder="Enter admin password"
                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-center"
                    autoFocus
                    required
                  />
                </div>

                {passwordError && (
                  <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded text-center">
                    <p className="text-sm">{passwordError}</p>
                  </div>
                )}

                <button
                  type="submit"
                  className="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors"
                >
                  Access Admin Panel
                </button>
              </form>
            </div>
          </div>
        );

        const AdminScreen = () => (
          <div className="space-y-6">
            <div className="flex items-center justify-between mb-6">
              <div className="flex items-center space-x-3">
                <button onClick={handleAdminLogout} className="text-blue-600 hover:text-blue-800">
                  <span style={{fontSize: '24px'}}>â†</span>
                </button>
                <h2 className="text-xl font-bold">Admin Panel</h2>
              </div>
              <button
                onClick={handleAdminLogout}
                className="p-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded"
                title="Logout"
              >
                <span style={{fontSize: '20px'}}>ğŸšª</span>
              </button>
            </div>

            <div className="bg-white p-6 rounded-lg border">
              <h3 className="text-lg font-semibold mb-4">System Status</h3>
              <p className="text-green-600">âœ… System is working correctly</p>
              <p className="text-gray-600 mt-2">Transactions: {transactions.length}</p>
            </div>

            <div className="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
              <h4 className="font-semibold text-yellow-800 mb-2">Next Steps</h4>
              <p className="text-sm text-yellow-700">
                Basic app is working. Fee management will be added once this version is confirmed working.
              </p>
            </div>
          </div>
        );

        const DetailsScreen = () => (
          <div className="space-y-6">
            <div className="flex items-center space-x-3 mb-6">
              <button onClick={() => setCurrentStep('main')} className="text-blue-600 hover:text-blue-800">
                <span style={{fontSize: '24px'}}>â†</span>
              </button>
              <h2 className="text-xl font-bold capitalize">{paymentType.replace('-', ' ')}</h2>
            </div>

            <div className="bg-white p-6 rounded-lg border">
              <h3 className="text-lg font-semibold mb-4">Feature Coming Soon</h3>
              <p className="text-gray-600">
                {paymentType.charAt(0).toUpperCase() + paymentType.slice(1).replace('-', ' ')} payment form will be added once basic structure is confirmed working.
              </p>
              <button
                onClick={() => setCurrentStep('main')}
                className="mt-4 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors"
              >
                Back to Main Menu
              </button>
            </div>
          </div>
        );

        return (
          <div className="min-h-screen bg-gray-50 p-4">
            <div className="max-w-md mx-auto">
              {showAdmin ? (
                isAdminAuthenticated ? (
                  <AdminScreen />
                ) : (
                  <PasswordScreen />
                )
              ) : (
                <>
                  {currentStep === 'main' && <MainScreen />}
                  {currentStep === 'details' && <DetailsScreen />}
                </>
              )}
            </div>
          </div>
        );
      };

      const { createRoot } = ReactDOM;
      const root = createRoot(document.getElementById('root'));
      root.render(<MCGPaymentApp />);
    </script>
</body>
</html>
